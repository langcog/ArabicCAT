---
title: "Arabic CDI-CAT"
author: "George"
date: "5/12/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(mirt)
require(mirtCAT)
require(readxl)
```

## Load JISH Data

```{r load-data, echo=F}
# from Haifa Alroqi May 13, 2022 - JISH CDI (JACDI) norms 
# The data file has WG and WS. Column BXW (total.produce) represents the total number of words produced by the whole sample. 
# Column BXV (total.understand) represents the total number of words comprehended by, I think, the whole sample. 
# I assume JISH initially used the vocabulary list of WS (which has the 550 words from WG and additional 348 words that are specific to WS) to collect data on both expressive and receptive vocabulary size of the whole sample. 
# Columns BYG (age.months) and BYH (age.group) can help us distinguish between WG and WS. WG is for children aged 8-16 months; WS is for children aged 17-36 months. 
sheets <- readxl::excel_sheets(path="data/JISH - CDI Data.xlsx")

raw <- read_xlsx(path="data/JISH - CDI Data.xlsx", sheet="JACDI Data")

notes <- read_xlsx(path="data/JISH - CDI Data.xlsx", sheet="Notes")
# note there are red highlighted columns that were not included in the paper form (so maybe discard?)
# also: "yellow highlight cells means we don't know what the word is in Arabic or we don't know what the column represents"
codebook <- read_xlsx(path="data/JISH - CDI Data.xlsx", sheet="Codebook")

## new data from Haifa Alroqi June 7, 2022
sheets_wg <- readxl::excel_sheets(path="data/Alroqi et al. 2020 - Saudi CDI - WG.xlsx")
raw_wg <- read_xlsx(path="data/Alroqi et al. 2020 - Saudi CDI - WG.xlsx", sheet="Saudi CDI - WG")
notes_wg <- read_xlsx(path="data/Alroqi et al. 2020 - Saudi CDI - WG.xlsx", sheet="Notes")

sheets_ws <- readxl::excel_sheets(path="data/Alroqi et al. 2020 - Saudi CDI - WS.xlsx")
raw_ws <- read_xlsx(path="data/Alroqi et al. 2020 - Saudi CDI - WS.xlsx", sheet="Saudi CDI - WS")
notes_ws <- read_xlsx(path="data/Alroqi et al. 2020 - Saudi CDI - WS.xlsx", sheet="Notes")

intersect(raw_wg[1,], raw_ws[1,])
```

Are 'ant.1.u' and 'ant.1.p' understanding and production (on WG form)? 
But then why would there be 'ant.2.u' *and* 'ant.2.p'?

### Notes

```{r notes, echo=F}
# "JACDI WS has 898 words"                                                                                                 
# "JACDI WG has 550 word" 
# "some words are repeated in the data file here; e.g., ant, so we gave it numbers: ant.1.u, ant.1.p, ant.2.u, ant.2.p, .."
print(notes)
```

### Codebook

```{r}
na.omit(unique(codebook$`Variable Values`))
```

## Clean data

```{r create-item-dictionary, echo=F}
#cat_names <- names(raw)[which(!grepl("...", names(raw)))] # contains categories
# what are columns 1:104 ? gestures..? not words?
category = c(rep(names(raw)[105], 55), # "Sound Effects and Animal Sounds"
             rep(names(raw)[160], 113), # "Animals (Real or Toy)"
             rep(names(raw)[273], 61) ) # Toys
names(raw)[334] # Vehicles (Real or Toy)
names(raw)[373] # Food and Drink
names(raw)[554] # Clothing
names(raw)[641] # "Body Parts"
names(raw)[714] # "Small Household Items"
names(raw)[859] # "Furniture and Rooms"
names(raw)[968] # Outside Things
names(raw)[211] # People
names(raw)[1128] # "Games and Routines"
names(raw)[1229] # "Action words"
names(raw)[1522] # Descriptive Words
names(raw)[1701] # "Words About Time"
names(raw)[1728] # "Question Words"
names(raw)[1741] # Pronouns
names(raw)[1786] # Negation words
names(raw)[1809] # Quantifiers
names(raw)[1870] # "Prepositions and Locations"
names(raw)[1913] # "Connecting Words and Letters" 
# final word index: 2010 ("...2010")
names(raw)[2011:2017]
arabic_names <- unlist(raw[2,])
col_names <- unlist(raw[1,])

items <- bind_cols(definition=arabic_names[8:1988], uni_lemma=col_names[8:1988])

col_names[which(is.na(col_names))] = paste0("na.",1:23)

names(raw) = col_names

# have a bunch of entirely NA columns that need to be removed
# (Columns 159, 272, 333, 372, 553, and 18 more)
raw2 <- raw[3:nrow(raw),-which(is.na(items$definition))] # 645x1997
items <- items %>% filter(!is.na(definition)) # 1961

d_demo = raw[3:nrow(raw),c(1:7, 1989:2017)] # last three columns are na.21 - na.23 - check and drop these?

d_demo <- d_demo %>% mutate(age = as.numeric(age.months),
                            production = as.numeric(total.produce),
                            comprehension = as.numeric(total.understand)) %>%
  select(-age.months, -total.produce, -total.understand)

# cut out first signs, starting talk, phrases, first gestures, games.routines, actions.objects, 
# pretend.parent, and imitate.adults
raw2 <- raw2[,105:1906]
# at the end, cut out word endings, how use, complexity, the totals columns etc.

# now we need to separate production (".p") and comprehension (".c") columns
prod_voc <- raw2[,which(endsWith(names(raw2), ".p"))]
comp_voc <- raw2[,which(endsWith(names(raw2), ".u"))]

save(file="data/Arabic_data.Rds", "prod_voc", "comp_voc", "d_demo")
```

```{r load-data}
load("data/Arabic_data.Rds")

d_mat <- prod_voc %>% 
  #select(-data_id) %>% 
  data.frame %>%
  data.matrix

too_young <- which(d_demo$age < 12) # 83 children too young to be producing words...

no_words <- which(d_demo$production==0 & d_demo$age>=12) # 9 additional children not producing

young_not_producing = c(too_young, no_words)

table(d_demo$age_mos) %>% kable(col.names=c("Age","N"))
```

We use the provided production data from a total of `r nrow(d_demo)` participants. 
From this data we remove `r length(too_young)` children <12 months of age, who should not be producing any words yet. 
We also remove an additional `r length(no_words)` children 12+ months of age who are not yet producing any words, as these children cannot be used to fit the IRT models.
The production sumscores by age for the remaining children are shown below.

```{r}
ggplot(d_demo, aes(x = age, y = production)) + # , color=gender
  geom_jitter(alpha = .2) + theme_bw() + xlab("Age (months)") + ylab("Production Sumscore")
# gender 1=male, 2=female, or vice-versa? 
```


## Fit IRT Models


```{r psycho-models_1pl, echo=F, eval = RUN_MODELS}
set.seed(1234)

mod_1pl <- mirt(d_mat, 1, itemtype='Rasch', verbose=TRUE, technical=list(NCYCLES=1000))

coefs_1pl <- as_tibble(coef(mod_1pl, simplify = TRUE)$items) %>%
  mutate(definition = rownames(coef(mod_1pl, simplify = TRUE)$items))
fscores_1pl <- tibble(data_id = rownames(d_mat), 
                             ability = fscores(mod_1pl, method = "MAP")[,1])

save(file = "data/arabic_mod_1pl.Rds", "mod_1pl", "fscores_1pl", "coefs_1pl")
```

```{r psycho-2pl_coefs, echo=F, eval = RUN_MODELS}
mod_2pl <- mirt(d_mat, 1, itemtype='2PL', verbose=TRUE,  technical=list(NCYCLES=3000))

coefs_2pl <- as_tibble(coef(mod_2pl, simplify = TRUE)$items) %>%
  mutate(definition = rownames(coef(mod_2pl, simplify = TRUE)$items))
fscores_2pl <- tibble(data_id = rownames(d_mat), 
                             ability = fscores(mod_2pl, method = "MAP")[,1])

save(file = "data/fr_ws_wg_mod_2pl.Rds", "mod_2pl","fscores_2pl", "coefs_2pl")
```


